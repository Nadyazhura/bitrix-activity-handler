# Bitrix Activity Handler

Обработчик вебхуков для Bitrix24, который автоматически маршрутизирует входящие email-активности к соответствующим контактам, сделкам или лидам на основе адресов электронной почты и совпадения тем.

## Возможности

- Обрабатывает email-активности Bitrix24 через вебхуки
- Маршрутизирует emails к существующим сделкам или лидам, совпадающим по теме
- Создает новые лиды, когда не найдены подходящие сущности
- Комплексное логирование для отладки и мониторинга
- Безопасная аутентификация вебхуков

## Требования

- PHP 8.0 или выше
- Доступ к Bitrix24 с настроенным вебхуком
- Веб-сервер (Apache/Nginx) с поддержкой PHP

## Установка

1. Клонируйте или скачайте файлы проекта в директорию веб-сервера
2. Создайте файл `.env` в корневой директории со следующими переменными:
   ```
   WEBHOOK_SECRET=ваш_секрет_вебхука_здесь
   BITRIX_APP_TOKEN=ваш_токен_приложения_bitrix_здесь
   ```
3. Обновите `config/config.php` с вашим URL вебхука Bitrix24 и настройками логирования
4. Убедитесь, что директория `logs/` доступна для записи веб-сервером
5. Настройте вебхук Bitrix24, указывающий на `index.php` с параметром secret

## Конфигурация

### Переменные окружения (.env)

- `WEBHOOK_SECRET`: Секретный ключ для аутентификации вебхука
- `BITRIX_APP_TOKEN`: Токен приложения Bitrix24

### Файл конфигурации (config/config.php)

- `bitrix.webhook_url`: Ваш исходящий URL вебхука Bitrix24
- `log.type`: Тип логирования ('file' или 'syslog')
- `log.file`: Путь к файлу логов (при использовании файлового логирования)
- `log.level`: Уровень логирования (DEBUG, INFO, ERROR)

## Использование

1. Настройте исходящий вебхук в Bitrix24 для событий активности
2. Укажите URL вебхука на: `https://ваш-домен.com/index.php?secret=ВАШ_WEBHOOK_SECRET`
3. Когда emails поступают в Bitrix24, они будут автоматически обработаны и маршрутизированы

## Как это работает

1. Получает уведомление вебхука при создании email-активности
2. Проверяет тип активности (должен быть email, TYPE_ID = 4)
3. Извлекает email отправителя и тему
4. Ищет существующие контакты по email
5. Если контакт найден, ищет совпадающие сделки/лиды по теме
6. Если совпадений нет, ищет по всем сделкам и лидам
7. Если все еще нет совпадений, создает новый лид и клонирует активность

## Безопасность

- Запросы вебхука проверяются с использованием секрета и токена приложения
- Все запросы должны включать правильные заголовки аутентификации
- Недействительные запросы возвращают 403 Forbidden

## Логирование

Логи записываются в `logs/email-router.log` по умолчанию. Уровни логирования:

- DEBUG: Все операции
- INFO: Бизнес-события
- ERROR: Только ошибки
